<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë¬´ì¥í„° - Tree Market</title>
    
    <!-- 1. ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—°ê²° -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Toss Payments SDK -->
    <script src="https://js.tosspayments.com/v2/standard"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }

        @keyframes toastSlide {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: toastSlide 0.3s ease-out forwards; }

        .image-preview {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: transform 0.3s;
        }
        
        /* ë©¤ë²„ì‹­ ê³¨ë“œ ê·¸ë¼ë°ì´ì…˜ */
        .bg-gold-gradient {
            background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 50%, #D97706 100%);
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 pb-20 md:pb-0 relative min-h-screen flex flex-col">

    <!-- 2. HTML ì»¨í…Œì´ë„ˆ -->
    <div id="app" class="flex flex-col flex-grow w-full"></div>
    <div id="modals"></div>
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- 3. ìë°”ìŠ¤í¬ë¦½íŠ¸ ì‹œìŠ¤í…œ ë¡œì§ -->
    <script>
        // --- [System] ë°ì´í„° ì˜êµ¬ ì €ì¥ì†Œ ---
        const StorageSystem = {
            KEY: 'treeMarket_v7_toss', 
            save: (data) => {
                try {
                    const { isGenerating, showAIChat, modals, activeTab, ...saveData } = data; 
                    saveData.sellForm = defaultState.sellForm; 
                    localStorage.setItem(StorageSystem.KEY, JSON.stringify(saveData));
                } catch (e) { console.error('ì €ì¥ ì‹¤íŒ¨:', e); }
            },
            load: () => {
                try {
                    const data = localStorage.getItem(StorageSystem.KEY);
                    return data ? JSON.parse(data) : null;
                } catch (e) { return null; }
            },
            clear: () => localStorage.removeItem(StorageSystem.KEY)
        };

        // --- [System] í† ìŠ¤íŠ¸ ì•Œë¦¼ ---
        const Toast = {
            show: (message, type = 'success') => {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                let bgClass, icon;
                
                if (type === 'success') { bgClass = 'bg-green-700'; icon = 'check-circle'; }
                else if (type === 'error') { bgClass = 'bg-red-600'; icon = 'alert-circle'; }
                else if (type === 'gold') { bgClass = 'bg-gold-gradient'; icon = 'crown'; } 
                else { bgClass = 'bg-stone-800'; icon = 'info'; }

                el.className = `${bgClass} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 min-w-[300px] toast-enter pointer-events-auto`;
                el.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i><span class="font-medium text-sm">${message}</span>`;
                
                container.appendChild(el);
                lucide.createIcons();
                
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(-10px)';
                    el.style.transition = 'all 0.3s';
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            }
        };

        // --- [State] ì´ˆê¸° ë°ì´í„° ---
        const defaultState = {
            activeTab: 'market',
            isLoggedIn: false,
            currentUser: null, 
            searchTerm: '',
            selectedCategory: 'ì „ì²´',
            viewFilter: 'all', 
            showAIChat: false,
            aiChatInput: '',
            listings: [
                { id: 1, name: 'ì—ë©”ë„ë“œ ê·¸ë¦°', category: 'ì¡°ê²½ìˆ˜', price: 150000, height: '1.5m', location: 'ì¶©ë¶ ì˜¥ì²œêµ°', seller: 'ê¹€ë‚˜ë¬´', sellerId: 'seller1', isBusiness: true, isPremium: true, businessName: 'ì²­ì •ë¬˜ëª©ë†ì›', image: 'https://images.unsplash.com/photo-1598335624129-87c2fb28532c?w=400&q=80', status: 'íŒë§¤ì¤‘' },
                { id: 2, name: 'ì™•ë²šë‚˜ë¬´ R15', category: 'ê´€ìƒìˆ˜', price: 450000, height: '3.0m', location: 'ê²½ê¸° ìš©ì¸ì‹œ', seller: 'ë°•ì¡°ê²½', sellerId: 'seller2', isBusiness: false, isPremium: false, businessName: '', image: 'https://images.unsplash.com/photo-1524234599372-a5bd0194758d?w=400&q=80', status: 'íŒë§¤ì¤‘' },
                { id: 3, name: 'ë°˜ì†¡ (ë‘¥ê·¼ ì†Œë‚˜ë¬´)', category: 'íŠ¹ìˆ˜ëª©', price: 1200000, height: '1.2m', location: 'ê°•ì› ì›ì£¼ì‹œ', seller: 'ì´ì†”', sellerId: 'seller3', isBusiness: true, isPremium: true, businessName: 'ì†”í–¥ê¸°ì¡°ê²½', image: 'https://images.unsplash.com/photo-1579624589252-b892a0e2831f?w=400&q=80', status: 'íŒë§¤ì¤‘' }
            ],
            chats: [
                { id: 1, partnerName: 'ë°•ì¡°ê²½', lastMessage: 'ì™•ë²šë‚˜ë¬´ 10ì£¼ êµ¬ë§¤ ê°€ëŠ¥í•œê°€ìš”?', time: 'ë°©ê¸ˆ ì „', unread: 2, itemId: 2, messages: [{ id: 1, sender: 'me', text: 'ì•ˆë…•í•˜ì„¸ìš”, ì™•ë²šë‚˜ë¬´ ë³´ê³  ì—°ë½ë“œë¦½ë‹ˆë‹¤.', time: '10:00' }, { id: 2, sender: 'partner', text: 'ë„¤ ì•ˆë…•í•˜ì„¸ìš”!', time: '10:05' }] }
            ],
            activeChatId: null,
            aiChatMessages: [{ role: 'model', text: 'ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” AI ì •ì›ì‚¬ì…ë‹ˆë‹¤. ë‚˜ë¬´ì— ëŒ€í•´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”! ğŸŒ²' }],
            sellForm: { name: '', category: 'ì¡°ê²½ìˆ˜', price: '', height: '', location: '', description: '', isBusiness: false, businessName: '', businessRegNumber: '', previewImage: null },
            isGenerating: false,
            modals: { login: false, payment: null, settings: false },
            tossWidgets: null // ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ìš©
        };

        const loadedData = StorageSystem.load();
        const state = loadedData ? { ...defaultState, ...loadedData, sellForm: defaultState.sellForm, isGenerating: false, modals: {login:false, payment:null, settings:false}, viewFilter: 'all' } : defaultState;

        // --- [Render] í™”ë©´ ë Œë”ë§ ---
        function render() {
            const app = document.getElementById('app');
            const modals = document.getElementById('modals');
            
            app.innerHTML = `
                ${Header()}
                <main class="max-w-4xl mx-auto px-4 py-6 flex-grow w-full">
                    ${renderActiveTab()}
                </main>
                ${FloatingAIButton()}
                ${MobileNav()}
                <div class="hidden md:block">${Footer()}</div>
            `;

            // ëª¨ë‹¬ ë Œë”ë§
            modals.innerHTML = `
                ${state.modals.login ? LoginModal() : ''}
                ${state.modals.payment ? PaymentModal(state.modals.payment) : ''}
                ${state.modals.settings ? SettingsModal() : ''}
                ${state.showAIChat ? AIChatModal() : ''}
            `;

            lucide.createIcons();
            StorageSystem.save(state);
            
            // í›„ì† ì²˜ë¦¬
            if (state.activeTab === 'chat' && state.activeChatId) scrollChatToBottom('chat-messages');
            if (state.showAIChat) scrollChatToBottom('ai-chat-messages');
            
            // í† ìŠ¤ ê²°ì œ ìœ„ì ¯ ë Œë”ë§ íŠ¸ë¦¬ê±°
            if (state.modals.payment) {
                setTimeout(() => renderTossWidget(state.modals.payment), 50); // DOM ë Œë”ë§ í›„ ì‹¤í–‰
            }
        }

        function scrollChatToBottom(id) {
            const el = document.getElementById(id);
            if(el) el.scrollTop = el.scrollHeight;
        }

        function renderActiveTab() {
            switch(state.activeTab) {
                case 'market': return MarketTab();
                case 'chat': return ChatTab();
                case 'sell': return SellTab();
                case 'profile': return ProfileTab();
                default: return MarketTab();
            }
        }

        // --- [Components] ---

        const Header = () => `
            <header class="bg-green-800 text-white shadow-lg sticky top-0 z-20">
                <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center space-x-2 cursor-pointer group" onclick="goHome()">
                        <i data-lucide="trees" class="text-green-300 w-6 h-6 group-hover:scale-110 transition-transform"></i>
                        <h1 class="text-xl font-bold tracking-tight">ë‚˜ë¬´ì¥í„°</h1>
                    </div>
                    <div class="flex items-center gap-2">
                        ${!state.isLoggedIn ? `
                            <button onclick="toggleLogin(true)" class="flex items-center px-3 py-1.5 bg-green-900/50 hover:bg-green-900 rounded-lg text-sm transition-colors">
                                <i data-lucide="log-in" class="w-3.5 h-3.5 mr-1"></i> ë¡œê·¸ì¸
                            </button>
                        ` : `
                            <div class="flex items-center gap-2">
                                <button onclick="openSettings()" class="flex items-center gap-1.5 hover:bg-green-700 px-3 py-1.5 rounded-lg transition-colors group">
                                    <div class="relative">
                                        <i data-lucide="user" class="w-4 h-4 text-green-200"></i>
                                        ${state.currentUser.isPremium ? '<div class="absolute -top-1 -right-1 w-2 h-2 bg-yellow-400 rounded-full border border-green-800 animate-pulse"></div>' : ''}
                                    </div>
                                    <span class="text-sm text-green-50 hidden md:inline font-bold group-hover:text-white flex items-center gap-1">
                                        ${state.currentUser.name}ë‹˜
                                        ${state.currentUser.isPremium ? '<i data-lucide="crown" class="w-3 h-3 text-yellow-400 fill-yellow-400"></i>' : ''}
                                    </span>
                                </button>
                                <button onclick="logout()" class="p-2 hover:bg-green-700 rounded-lg text-green-200 hover:text-white transition-colors"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                            </div>
                        `}
                    </div>
                </div>
            </header>
        `;

        // ... MarketTab, ChatTab, SellTab, ProfileTab, LoginModal, SettingsModal, AIChatModal ë“± ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ëŠ” ë™ì¼í•˜ê²Œ ìœ ì§€ ...
        // (ì§€ë©´ ê´€ê³„ìƒ ì¤‘ë³µë˜ëŠ” ê¸´ ì½”ë“œëŠ” ìƒëµí•˜ê³  í•µì‹¬ ë³€ê²½ì‚¬í•­ì¸ PaymentModalê³¼ ë¡œì§ì— ì§‘ì¤‘í•©ë‹ˆë‹¤)
        // ì‹¤ì œ íŒŒì¼ì—ëŠ” ì´ ë¶€ë¶„ë“¤ì— ì´ì „ì— ì‘ì„±í•œ ì½”ë“œê°€ ê·¸ëŒ€ë¡œ ë“¤ì–´ê°€ì•¼ í•©ë‹ˆë‹¤.
        
        const MarketTab = () => {
            const filtered = state.listings.filter(item => {
                const catMatch = state.selectedCategory === 'ì „ì²´' || item.category === state.selectedCategory;
                const searchMatch = item.name.includes(state.searchTerm) || item.location.includes(state.searchTerm);
                const myMatch = state.viewFilter === 'my' ? (state.isLoggedIn && item.sellerId === state.currentUser.id) : true;
                return catMatch && searchMatch && myMatch;
            });

            return `
                <div class="space-y-6 animate-fade-in">
                    ${state.viewFilter === 'my' ? `
                        <div class="flex justify-between items-center bg-white p-5 rounded-2xl border border-stone-200 shadow-sm">
                            <div>
                                <h3 class="font-bold text-lg text-stone-800 flex items-center gap-2"><i data-lucide="store" class="text-green-600"></i> ë‚´ íŒë§¤ê¸€ ê´€ë¦¬</h3>
                                <p class="text-stone-500 text-xs mt-1">ë“±ë¡í•œ ìƒí’ˆ: ${filtered.length}ê°œ</p>
                            </div>
                            <button onclick="setViewFilter('all')" class="text-xs bg-stone-100 hover:bg-stone-200 px-3 py-1.5 rounded-lg text-stone-600 transition-colors">ëª©ë¡ ë‹«ê¸°</button>
                        </div>
                        <button onclick="setActiveTab('sell')" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold transition-all shadow-md flex items-center justify-center gap-2 transform active:scale-95">
                            <i data-lucide="plus" class="w-5 h-5"></i> ìƒˆ íŒë§¤ê¸€ ë“±ë¡í•˜ê¸°
                        </button>
                    ` : `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-200">
                            <div class="flex gap-2 mb-4">
                                <div class="relative flex-grow">
                                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400 w-5 h-5"></i>
                                    <input type="text" placeholder="ì–´ë–¤ ë‚˜ë¬´ë¥¼ ì°¾ìœ¼ì„¸ìš”?" 
                                        class="w-full pl-10 pr-4 py-3 bg-stone-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                                        value="${state.searchTerm}" oninput="handleSearch(this.value)">
                                </div>
                            </div>
                            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                ${['ì „ì²´', 'ì¡°ê²½ìˆ˜', 'ê´€ìƒìˆ˜', 'íŠ¹ìˆ˜ëª©', 'ë¬˜ëª©'].map(cat => `
                                    <button onclick="setCategory('${cat}')" 
                                        class="px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap border transition-colors ${state.selectedCategory === cat ? 'bg-green-700 text-white border-green-700' : 'bg-white text-stone-600 border-stone-200 hover:bg-stone-50'}">
                                        ${cat}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        ${filtered.length > 0 ? filtered.map(item => `
                            <div class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-all border ${item.isPremium ? 'border-yellow-200 ring-1 ring-yellow-100' : 'border-stone-100'} flex flex-col relative group">
                                <div class="h-52 bg-stone-200 relative overflow-hidden">
                                    <img src="${item.image}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                                    <div class="absolute top-3 left-3 flex gap-2">
                                        <span class="bg-black/60 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">${item.category}</span>
                                        <span class="${item.status === 'íŒë§¤ì¤‘' ? 'bg-green-600' : 'bg-stone-600'} text-white text-xs px-2 py-1 rounded shadow-sm font-bold">${item.status}</span>
                                    </div>
                                    ${item.isBusiness ? '<div class="absolute bottom-3 left-3 bg-blue-600 text-white text-xs px-2 py-1 rounded-full shadow-md flex items-center gap-1"><i data-lucide="building-2" class="w-3 h-3"></i> ì‚¬ì—…ì</div>' : ''}
                                    ${item.status === 'íŒë§¤ì™„ë£Œ' ? '<div class="absolute inset-0 flex items-center justify-center bg-black/30 text-white font-bold text-2xl">íŒë§¤ì™„ë£Œ</div>' : ''}
                                </div>
                                <div class="p-5 flex-grow flex flex-col">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="text-lg font-bold text-stone-900 truncate flex items-center gap-1">
                                            ${item.name}
                                            ${item.isPremium ? '<i data-lucide="crown" class="w-4 h-4 text-yellow-500 fill-yellow-500"></i>' : ''}
                                        </h3>
                                        <span class="text-green-700 font-bold text-lg whitespace-nowrap">${item.price.toLocaleString()}ì›</span>
                                    </div>
                                    <div class="space-y-1.5 text-sm text-stone-500 mb-4">
                                        <p class="flex items-center"><i data-lucide="user" class="mr-1.5 w-3.5 h-3.5"></i> ${item.seller} ${item.isPremium ? '<span class="ml-1 text-[10px] bg-yellow-100 text-yellow-700 px-1 rounded border border-yellow-200">Premium</span>' : ''}</p>
                                        <p class="flex items-center"><i data-lucide="map-pin" class="mr-1.5 w-3.5 h-3.5"></i> ${item.location}</p>
                                    </div>
                                    <div class="mt-auto grid grid-cols-2 gap-3">
                                        ${state.isLoggedIn && item.sellerId === state.currentUser.id ? `
                                            <button onclick="toggleStatus(${item.id})" class="py-2.5 px-3 bg-stone-100 hover:bg-stone-200 text-stone-700 rounded-lg font-bold text-sm transition-colors">
                                                ${item.status === 'íŒë§¤ì¤‘' ? 'íŒë§¤ì™„ë£Œ ì²˜ë¦¬' : 'íŒë§¤ì¤‘ ì²˜ë¦¬'}
                                            </button>
                                            <button onclick="deleteListing(${item.id})" class="py-2.5 px-3 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg font-bold text-sm transition-colors">ì‚­ì œí•˜ê¸°</button>
                                        ` : `
                                            <button onclick="startChat(${item.id})" class="py-2.5 px-3 bg-stone-100 text-stone-700 rounded-lg font-bold text-sm hover:bg-stone-200 flex justify-center items-center"><i data-lucide="message-circle" class="mr-1.5 w-4 h-4"></i> ì±„íŒ…</button>
                                            <button onclick="openPayment(${item.id})" class="py-2.5 px-3 bg-green-600 text-white rounded-lg font-bold text-sm hover:bg-green-700 flex justify-center items-center shadow-md"><i data-lucide="shield-check" class="mr-1.5 w-4 h-4"></i> ì•ˆì „ê²°ì œ</button>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `).join('') : `
                            <div class="col-span-full py-20 text-center text-stone-400 bg-white rounded-2xl border border-stone-100 border-dashed">
                                <i data-lucide="tree-pine" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                                <p>${state.viewFilter === 'my' ? 'ë“±ë¡ëœ íŒë§¤ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        };

        const ChatTab = () => {
            if (!state.isLoggedIn) return LoginRequestUI('ì±„íŒ…');
            const activeChat = state.chats.find(c => c.id === state.activeChatId);

            return `
                <div class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden h-[calc(100vh-140px)] flex animate-fade-in">
                    <div class="${state.activeChatId ? 'hidden md:block' : 'w-full'} md:w-1/3 border-r border-stone-100 flex flex-col">
                        <div class="p-4 border-b border-stone-100 font-bold text-lg text-stone-800 flex justify-between items-center">
                            <span>ì±„íŒ…ëª©ë¡</span>
                            <span class="text-xs font-normal bg-green-100 text-green-800 px-2 py-1 rounded-full">${state.chats.length}</span>
                        </div>
                        <div class="overflow-y-auto flex-1">
                            ${state.chats.length > 0 ? state.chats.map(chat => `
                                <div onclick="setActiveChat(${chat.id})" class="p-4 border-b border-stone-50 cursor-pointer hover:bg-stone-50 transition-colors ${state.activeChatId === chat.id ? 'bg-green-50 border-l-4 border-l-green-600' : ''}">
                                    <div class="flex justify-between mb-1">
                                        <span class="font-bold text-stone-800">${chat.partnerName}</span>
                                        <span class="text-xs text-stone-400">${chat.time}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <p class="text-sm text-stone-500 truncate max-w-[80%]">${chat.lastMessage}</p>
                                        ${chat.unread > 0 ? `<span class="bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full">${chat.unread}</span>` : ''}
                                    </div>
                                </div>
                            `).join('') : '<div class="p-4 text-center text-stone-400 text-sm">ëŒ€í™” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'}
                        </div>
                    </div>
                    <div class="${!state.activeChatId ? 'hidden md:flex' : 'w-full'} md:w-2/3 flex flex-col bg-stone-50">
                        ${state.activeChatId ? `
                            <div class="p-4 bg-white border-b border-stone-100 flex items-center justify-between shadow-sm z-10">
                                <div class="flex items-center">
                                    <button onclick="setActiveChat(null)" class="md:hidden mr-3 text-stone-400"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                                    <div class="font-bold text-lg">${activeChat.partnerName}</div>
                                </div>
                            </div>
                            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                                ${activeChat.messages.map(msg => `
                                    <div class="flex ${msg.sender === 'me' ? 'justify-end' : 'justify-start'}">
                                        <div class="max-w-[70%] p-3 rounded-2xl text-sm ${msg.sender === 'me' ? 'bg-green-600 text-white rounded-tr-none shadow-md' : 'bg-white border border-stone-200 text-stone-800 rounded-tl-none shadow-sm'}">
                                            ${msg.text}
                                        </div>
                                        <span class="text-[10px] text-stone-300 self-end ml-1 mr-1 mb-1">${msg.time}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <form onsubmit="event.preventDefault(); sendMessage(this.msg.value, this.msg);" class="p-3 bg-white border-t border-stone-200 flex gap-2">
                                <input name="msg" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..." class="flex-1 p-3 bg-stone-100 rounded-xl focus:outline-none focus:ring-1 focus:ring-green-500">
                                <button type="submit" class="p-3 bg-green-700 text-white rounded-xl hover:bg-green-800 transition-colors"><i data-lucide="send" class="w-5 h-5"></i></button>
                            </form>
                        ` : `<div class="flex-1 flex items-center justify-center text-stone-400 flex-col"><i data-lucide="message-circle" class="w-16 h-16 mb-4 opacity-10"></i><p>ì±„íŒ… ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”</p></div>`}
                    </div>
                </div>
            `;
        };

        const SellTab = () => {
            if (!state.isLoggedIn) return LoginRequestUI('íŒë§¤ ë“±ë¡');
            return `
                <div class="max-w-2xl mx-auto bg-white p-6 rounded-2xl shadow-sm border border-stone-200 animate-fade-in">
                    <h2 class="text-2xl font-bold mb-6 flex items-center"><i data-lucide="plus" class="mr-2 text-green-600"></i> ë‚´ ë‚˜ë¬´ íŒë§¤ ë“±ë¡</h2>
                    
                    <div class="mb-6 p-4 ${state.currentUser.isPremium ? 'bg-yellow-50 border-yellow-200' : 'bg-green-50 border-green-100'} border rounded-xl flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity" onclick="openSettings()">
                         <div class="bg-white p-2 rounded-full shadow-sm relative">
                            <i data-lucide="user" class="${state.currentUser.isPremium ? 'text-yellow-600' : 'text-green-600'} w-5 h-5"></i>
                            ${state.currentUser.isPremium ? '<div class="absolute -top-1 -right-1"><i data-lucide="crown" class="w-3 h-3 text-yellow-500 fill-yellow-500"></i></div>' : ''}
                         </div>
                         <div class="flex-1">
                            <p class="text-xs text-stone-500">íŒë§¤ìëª… (ì„¤ì •ì—ì„œ ë³€ê²½)</p>
                            <p class="font-bold text-stone-900 flex items-center gap-1">
                                ${state.currentUser.name} 
                                ${state.currentUser.isPremium ? '<span class="text-[10px] bg-yellow-400 text-white px-1.5 py-0.5 rounded-full font-bold shadow-sm">PREMIUM</span>' : ''}
                                <i data-lucide="edit-2" class="w-3 h-3 text-stone-400"></i>
                            </p>
                         </div>
                    </div>

                    <form onsubmit="handleSellSubmit(event)" class="space-y-6">
                        <div class="bg-stone-50 p-4 rounded-xl border border-stone-200">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" onchange="updateSellForm('isBusiness', this.checked)" ${state.sellForm.isBusiness ? 'checked' : ''} class="w-5 h-5 text-green-600 rounded">
                                <span class="font-bold">ì‚¬ì—…ì íŒë§¤ìì¸ê°€ìš”?</span>
                            </label>
                            ${state.sellForm.isBusiness ? `
                                <div class="grid grid-cols-2 gap-4 mt-4 animate-slide-down">
                                    <input oninput="updateSellForm('businessName', this.value)" value="${state.sellForm.businessName}" placeholder="ìƒí˜¸ëª…" class="p-2.5 border rounded-lg w-full outline-none focus:ring-2 focus:ring-green-500">
                                    <input oninput="updateSellForm('businessRegNumber', this.value)" value="${state.sellForm.businessRegNumber}" placeholder="ì‚¬ì—…ìë²ˆí˜¸" class="p-2.5 border rounded-lg w-full outline-none focus:ring-2 focus:ring-green-500">
                                </div>` : ''}
                        </div>
                        <div class="space-y-1">
                            <label class="text-sm font-medium text-stone-600">ë‚˜ë¬´ ì´ë¦„</label>
                            <input required oninput="updateSellForm('name', this.value)" value="${state.sellForm.name}" placeholder="ì˜ˆ: ì†Œë‚˜ë¬´ 2ë…„ìƒ" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-stone-600">ì¹´í…Œê³ ë¦¬</label>
                                <select onchange="updateSellForm('category', this.value)" class="p-3 border rounded-lg w-full outline-none focus:ring-2 focus:ring-green-500">
                                    ${['ì¡°ê²½ìˆ˜', 'ê´€ìƒìˆ˜', 'íŠ¹ìˆ˜ëª©', 'ë¬˜ëª©'].map(c => `<option value="${c}" ${state.sellForm.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-stone-600">ê°€ê²©</label>
                                <input required type="number" oninput="updateSellForm('price', this.value)" value="${state.sellForm.price}" placeholder="ì›" class="p-3 border rounded-lg w-full outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-stone-600">ê·œê²©</label>
                                <input required oninput="updateSellForm('height', this.value)" value="${state.sellForm.height}" placeholder="ì˜ˆ: 2m, R15" class="p-3 border rounded-lg w-full outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-stone-600">ìœ„ì¹˜</label>
                                <input required oninput="updateSellForm('location', this.value)" value="${state.sellForm.location}" placeholder="ì˜ˆ: ê°•ì›ë„ í™ì²œ" class="p-3 border rounded-lg w-full outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-medium text-stone-600">ìƒì„¸ ì„¤ëª…</label>
                                <button type="button" onclick="generateDescription()" ${state.isGenerating ? 'disabled' : ''} class="text-xs flex items-center gap-1 bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-3 py-1.5 rounded-md hover:opacity-90 transition-opacity disabled:opacity-50 shadow-sm">
                                    <i data-lucide="sparkles" class="w-3 h-3"></i> ${state.isGenerating ? 'AI ì‘ì„± ì¤‘...' : 'AI ìë™ì‘ì„±'}
                                </button>
                            </div>
                            <textarea required rows="5" oninput="updateSellForm('description', this.value)" placeholder="ë‚˜ë¬´ì˜ íŠ¹ì§•, ìˆ˜í˜•, ê´€ë¦¬ ìƒíƒœ ë“±ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”." class="w-full p-3 border rounded-lg resize-none outline-none focus:ring-2 focus:ring-green-500">${state.sellForm.description}</textarea>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-stone-600">ì‚¬ì§„ ë“±ë¡</label>
                            <div class="relative w-full h-56 border-2 border-dashed border-stone-300 rounded-xl overflow-hidden cursor-pointer hover:bg-stone-50 transition-colors group" onclick="document.getElementById('fileInput').click()">
                                ${state.sellForm.previewImage ? `
                                    <div class="w-full h-full image-preview" style="background-image: url('${state.sellForm.previewImage}');"></div>
                                    <div class="absolute inset-0 bg-black/40 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        <i data-lucide="refresh-cw" class="text-white w-8 h-8 mb-2"></i>
                                        <p class="text-white font-bold text-sm">ì‚¬ì§„ ë³€ê²½í•˜ê¸°</p>
                                    </div>
                                ` : `
                                    <div class="absolute inset-0 flex flex-col items-center justify-center text-stone-400">
                                        <i data-lucide="camera" class="w-10 h-10 mb-3 opacity-50"></i>
                                        <p class="text-sm font-medium">í´ë¦­í•˜ì—¬ ì‚¬ì§„ ì—…ë¡œë“œ</p>
                                        <p class="text-xs mt-1 text-stone-300">ìµœëŒ€ 5MB, JPG/PNG</p>
                                    </div>
                                `}
                                <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleImageUpload(this)">
                            </div>
                        </div>

                        <button type="submit" class="w-full py-4 bg-green-700 text-white rounded-xl font-bold hover:bg-green-800 shadow-lg transition-transform active:scale-95">íŒë§¤ê¸€ ë“±ë¡í•˜ê¸°</button>
                    </form>
                </div>
            `;
        };

        const ProfileTab = () => {
            if (!state.isLoggedIn) return LoginRequestUI('ë‚´ ì •ë³´');
            const myListingCount = state.listings.filter(i => i.sellerId === state.currentUser.id).length;
            
            return `
                <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-sm border border-stone-200 animate-fade-in overflow-hidden">
                    <div class="${state.currentUser.isPremium ? 'bg-gold-gradient' : 'bg-green-800'} text-white p-8 pb-16 relative transition-colors duration-500">
                        <button onclick="openSettings()" class="absolute top-4 right-4 bg-white/20 p-2 rounded-full hover:bg-white/30 transition-colors"><i data-lucide="settings" class="w-5 h-5"></i></button>
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center text-2xl font-bold backdrop-blur-md border-2 border-white/30 cursor-pointer" onclick="openSettings()">${state.currentUser.name[0]}</div>
                                ${state.currentUser.isPremium ? '<div class="absolute -bottom-1 -right-1 bg-yellow-500 rounded-full p-1 border-2 border-white"><i data-lucide="crown" class="w-4 h-4 fill-white"></i></div>' : ''}
                            </div>
                            <div onclick="openSettings()" class="cursor-pointer group">
                                <h2 class="text-2xl font-bold flex items-center gap-2">${state.currentUser.name} <i data-lucide="edit-3" class="w-4 h-4 opacity-50 group-hover:opacity-100"></i></h2>
                                <p class="text-white/80 text-sm">${state.currentUser.email}</p>
                                <div class="mt-2 inline-flex items-center px-2 py-1 bg-black/20 rounded text-xs">
                                    ${state.currentUser.isPremium ? '<span class="font-bold text-yellow-100 flex items-center gap-1"><i data-lucide="star" class="w-3 h-3 fill-current"></i> Premium Member</span>' : '<span class="flex items-center gap-1"><i data-lucide="shield-check" class="w-3 h-3"></i> ì¼ë°˜ íšŒì›</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="px-6 -mt-10 mb-6">
                        <div class="bg-white rounded-xl shadow-md p-6 grid grid-cols-3 gap-4 text-center border border-stone-100">
                            <div onclick="setViewFilter('my')" class="cursor-pointer hover:bg-stone-50 rounded-lg p-1 transition-colors">
                                <p class="text-xl font-bold text-green-700">${myListingCount}</p>
                                <p class="text-xs text-stone-500">íŒë§¤ì¤‘</p>
                            </div>
                            <div class="border-x"><p class="text-xl font-bold">0</p><p class="text-xs text-stone-500">êµ¬ë§¤ë‚´ì—­</p></div>
                            <div><p class="text-xl font-bold">0</p><p class="text-xs text-stone-500">ê´€ì‹¬ëª©ë¡</p></div>
                        </div>
                    </div>

                    <div class="px-6 mb-6">
                        <div class="relative rounded-2xl overflow-hidden shadow-lg group">
                            <div class="absolute inset-0 bg-gradient-to-r from-gray-900 to-gray-800"></div>
                            ${state.currentUser.isPremium ? `
                                <div class="relative p-6 text-white overflow-hidden">
                                    <div class="absolute top-0 right-0 w-32 h-32 bg-yellow-500 rounded-full blur-3xl opacity-20 -mr-10 -mt-10"></div>
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="font-bold text-xl text-yellow-400 flex items-center gap-2"><i data-lucide="crown" class="w-5 h-5 fill-current"></i> ë‚˜ë¬´ íŒ¨ìŠ¤ (Premium)</h3>
                                            <p class="text-xs text-gray-400 mt-1">ëª¨ë“  í”„ë¦¬ë¯¸ì—„ í˜œíƒ ì´ìš© ì¤‘</p>
                                        </div>
                                        <span class="bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded">ACTIVE</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-300">
                                        <p class="flex items-center gap-1"><i data-lucide="check" class="w-3 h-3 text-green-400"></i> íŒë§¤ ìˆ˜ìˆ˜ë£Œ 0ì›</p>
                                        <p class="flex items-center gap-1"><i data-lucide="check" class="w-3 h-3 text-green-400"></i> ê³¨ë“œ ë°°ì§€ ì¥ì°©</p>
                                    </div>
                                </div>
                            ` : `
                                <div class="relative p-6 text-white">
                                    <div class="absolute inset-0 bg-gold-gradient opacity-0 group-hover:opacity-10 transition-opacity"></div>
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="crown" class="w-5 h-5 text-yellow-400"></i> ë‚˜ë¬´ íŒ¨ìŠ¤</h3>
                                        <span class="text-xs bg-white/10 px-2 py-1 rounded">ì›” 4,900ì›</span>
                                    </div>
                                    <p class="text-sm text-gray-300 mb-4">íŒë§¤ ìˆ˜ìˆ˜ë£Œ 0ì›, íŒë§¤ê¸€ ê°•ì¡°, ê³¨ë“œ ë°°ì§€ ë“±<br>í”„ë¦¬ë¯¸ì—„ í˜œíƒì„ ëˆ„ë ¤ë³´ì„¸ìš”!</p>
                                    <button onclick="upgradeMembership()" class="w-full py-2 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-400 hover:to-yellow-500 text-black font-bold rounded-lg shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-2">
                                        <i data-lucide="sparkles" class="w-4 h-4"></i> ë‚˜ë¬´ íŒ¨ìŠ¤ ì‹œì‘í•˜ê¸°
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>

                    <div class="px-6 pb-10 space-y-2">
                        <button onclick="setViewFilter('my')" class="w-full flex justify-between items-center p-4 bg-stone-50 hover:bg-stone-100 rounded-xl text-left font-medium transition-colors">
                            <span class="flex items-center gap-2"><i data-lucide="list" class="w-4 h-4 text-stone-500"></i> ë‚´ íŒë§¤ê¸€ ê´€ë¦¬</span> 
                            <i data-lucide="chevron-right" class="w-4 h-4 text-stone-400"></i>
                        </button>
                        <button onclick="openSettings()" class="w-full flex justify-between items-center p-4 bg-stone-50 hover:bg-stone-100 rounded-xl text-left font-medium mt-2">
                            <span class="flex items-center gap-2"><i data-lucide="user-cog" class="w-4 h-4 text-stone-500"></i> ë‚´ ì •ë³´ / ë‹‰ë„¤ì„ ìˆ˜ì •</span> 
                            <i data-lucide="chevron-right" class="w-4 h-4 text-stone-400"></i>
                        </button>
                        <button onclick="logout()" class="w-full flex justify-between items-center p-4 bg-red-50 hover:bg-red-100 rounded-xl text-left font-bold text-red-500 mt-4">
                            ë¡œê·¸ì•„ì›ƒ <i data-lucide="log-out" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;
        };

        const LoginRequestUI = (featureName = 'ì´ ê¸°ëŠ¥') => `
            <div class="bg-white rounded-2xl shadow-sm border border-stone-200 p-8 text-center animate-fade-in py-20">
                <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="lock" class="text-stone-300 w-10 h-10"></i>
                </div>
                <h2 class="text-xl font-bold mb-2">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
                <p class="text-stone-500 mb-8">${featureName}ì„(ë¥¼) ì´ìš©í•˜ì‹œë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
                <button onclick="toggleLogin(true)" class="px-8 py-3 bg-green-700 text-white rounded-xl font-bold hover:bg-green-800 transition-colors shadow-lg">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</button>
            </div>
        `;

        const FloatingAIButton = () => `
            <button onclick="toggleAIChat(true)" class="fixed bottom-24 right-4 md:right-8 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white p-4 rounded-full shadow-lg z-30 transition-all hover:scale-110 flex items-center justify-center group">
                <i data-lucide="bot" class="w-7 h-7 group-hover:rotate-12 transition-transform"></i>
                <span class="absolute right-full mr-3 bg-black/80 text-white text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">AI ì •ì›ì‚¬</span>
            </button>
        `;

        const MobileNav = () => `
            <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-stone-200 px-6 py-2 z-30 flex justify-between items-center text-xs text-stone-500 font-medium pb-safe">
                ${['market:home:í™ˆ', 'chat:message-circle:ì±„íŒ…', 'sell:plus:íŒë§¤', 'profile:user-circle:ë‚´ì •ë³´'].map(item => {
                    const [key, icon, label] = item.split(':');
                    const isActive = state.activeTab === key;
                    return `<button onclick="goTab('${key}')" class="flex flex-col items-center p-2 transition-colors ${isActive ? 'text-green-700' : 'hover:text-stone-800'}">
                        <i data-lucide="${icon}" class="mb-1 w-6 h-6 ${isActive ? 'fill-current' : ''}"></i> ${label}
                    </button>`;
                }).join('')}
            </nav>
        `;

        const Footer = () => `
            <footer class="bg-stone-900 text-stone-400 py-12 px-6 mt-12 text-xs">
                <div class="max-w-4xl mx-auto">
                    <div class="grid grid-cols-2 gap-8 mb-8">
                        <div>
                            <h4 class="text-white font-bold mb-4 text-sm">ë‚˜ë¬´ì¥í„°</h4>
                            <p class="mb-1">ëŒ€í‘œ: ë°•ê±´ë„, ì´ìŠ¹ë¯¼ | ì‚¬ì—…ìë²ˆí˜¸: 123-45-67890</p>
                            <p>ì£¼ì†Œ: ê´‘ì–‘ì‹œ ìˆ²ì„¸ê¶Œ 1ë²ˆì§€</p>
                        </div>
                        <div>
                            <h4 class="text-white font-bold mb-4 text-sm">ê³ ê°ì„¼í„°</h4>
                            <p class="text-lg font-bold text-white mb-1">3883-4395</p>
                            <p>í‰ì¼ 09:00 - 18:00</p>
                        </div>
                    </div>
                    <div class="border-t border-stone-800 pt-6 text-center">
                        <p class="mb-2">ë‚˜ë¬´ì¥í„°ëŠ” í†µì‹ íŒë§¤ì¤‘ê°œìì´ë©° ìƒí’ˆ ì •ë³´ ë° ê±°ë˜ì— ëŒ€í•œ ì±…ì„ì€ ê° íŒë§¤ìì—ê²Œ ìˆìŠµë‹ˆë‹¤.</p>
                        <p>Â© 2025 Tree Market. All rights reserved.</p>
                    </div>
                </div>
            </footer>
        `;

        // --- [Modals] ---
        const LoginModal = () => `
            <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onclick="if(event.target === this) toggleLogin(false)">
                <div class="bg-white rounded-2xl w-full max-w-sm p-8 shadow-2xl animate-slide-up">
                    <div class="text-center mb-6">
                        <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="trees" class="text-green-700 w-8 h-8"></i></div>
                        <h2 class="text-2xl font-bold">ë¡œê·¸ì¸</h2>
                        <p class="text-stone-500 text-xs mt-2">íŒë§¤ í™œë™ì„ ìœ„í•´ ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
                    </div>
                    <form onsubmit="event.preventDefault(); login();" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-stone-600 mb-1 ml-1">ì´ë©”ì¼</label>
                            <input type="email" value="user@example.com" class="w-full p-3 bg-stone-50 border rounded-xl outline-none focus:ring-2 focus:ring-green-500" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-stone-600 mb-1 ml-1">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" value="password" class="w-full p-3 bg-stone-50 border rounded-xl outline-none focus:ring-2 focus:ring-green-500" required>
                        </div>
                         <div>
                            <label class="block text-xs font-bold text-stone-600 mb-1 ml-1">ë‹‰ë„¤ì„ (íŒë§¤ìëª…)</label>
                            <input type="text" id="loginNickname" placeholder="ì˜ˆ: í–‰ë³µí•œë‚˜ë¬´" class="w-full p-3 bg-white border border-green-200 rounded-xl outline-none focus:ring-2 focus:ring-green-500" required>
                        </div>
                        <button type="submit" class="w-full py-3 bg-green-700 text-white rounded-xl font-bold shadow-lg hover:bg-green-800 transition-colors mt-2">ë¡œê·¸ì¸ ë° íŒë§¤ ì‹œì‘</button>
                    </form>
                    <button onclick="toggleLogin(false)" class="w-full mt-4 text-stone-400 text-sm hover:text-stone-600">ë‹«ê¸°</button>
                </div>
            </div>
        `;

        const SettingsModal = () => `
            <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onclick="if(event.target === this) closeSettings()">
                <div class="bg-white rounded-2xl w-full max-w-sm p-8 shadow-2xl animate-slide-up">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5"></i> ë‚´ ì •ë³´ ì„¤ì •</h3>
                    
                    ${state.currentUser.isPremium ? `
                        <div class="mb-6 p-4 bg-gold-gradient rounded-xl text-white shadow-md relative overflow-hidden">
                             <div class="absolute inset-0 animate-shine opacity-30"></div>
                             <p class="font-bold flex items-center gap-2"><i data-lucide="crown" class="w-4 h-4 fill-white"></i> Premium Member</p>
                             <p class="text-xs opacity-90 mt-1">ë‚˜ë¬´ íŒ¨ìŠ¤ í˜œíƒì„ ì´ìš© ì¤‘ì…ë‹ˆë‹¤.</p>
                        </div>
                    ` : `
                        <div class="mb-6 p-4 bg-stone-100 rounded-xl border border-stone-200">
                             <p class="font-bold text-sm">ì¼ë°˜ íšŒì›</p>
                             <button onclick="closeSettings(); setActiveTab('profile');" class="text-xs text-green-700 font-bold mt-1 underline">ë‚˜ë¬´ íŒ¨ìŠ¤ë¡œ ì—…ê·¸ë ˆì´ë“œ í•˜ëŸ¬ê°€ê¸°</button>
                        </div>
                    `}

                    <div class="space-y-4">
                         <div>
                            <label class="block text-xs font-bold text-stone-600 mb-1 ml-1">ë‹‰ë„¤ì„ (íŒë§¤ìëª…) ë³€ê²½</label>
                            <input type="text" id="settingsNickname" value="${state.currentUser.name}" class="w-full p-3 bg-white border border-stone-200 rounded-xl outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <button onclick="saveSettings()" class="w-full py-3 bg-green-700 text-white rounded-xl font-bold shadow-lg hover:bg-green-800 transition-colors">ì €ì¥í•˜ê¸°</button>
                    </div>
                    <button onclick="closeSettings()" class="w-full mt-4 text-stone-400 text-sm hover:text-stone-600">ë‹«ê¸°</button>
                </div>
            </div>
        `;

        const AIChatModal = () => `
            <div class="fixed bottom-24 right-4 z-40 w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-stone-200 flex flex-col animate-slide-up h-[500px]">
                <div class="bg-gradient-to-r from-green-700 to-emerald-600 p-4 flex justify-between items-center text-white rounded-t-2xl">
                    <div class="flex items-center gap-2"><i data-lucide="bot" class="w-6 h-6"></i><div><p class="font-bold text-sm">AI ì •ì›ì‚¬</p><p class="text-[10px] opacity-80">ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”</p></div></div>
                    <button onclick="toggleAIChat(false)" class="hover:bg-white/20 rounded p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div id="ai-chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-stone-50">
                    ${state.aiChatMessages.map(msg => `
                        <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[85%] p-3 rounded-2xl text-sm shadow-sm ${msg.role === 'user' ? 'bg-green-600 text-white rounded-tr-none' : 'bg-white text-stone-800 border rounded-tl-none'}">
                                ${msg.text}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <form onsubmit="event.preventDefault(); sendAIChat(this.aiInput.value, this.aiInput);" class="p-3 bg-white border-t flex gap-2">
                    <input name="aiInput" type="text" placeholder="ì§ˆë¬¸í•˜ê¸°..." class="flex-1 p-2 bg-stone-100 rounded-lg outline-none focus:ring-1 focus:ring-green-500">
                    <button type="submit" class="p-2 bg-green-700 text-white rounded-lg hover:bg-green-800"><i data-lucide="send" class="w-4 h-4"></i></button>
                </form>
            </div>
        `;

        const PaymentModal = (item) => `
            <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onclick="if(event.target === this) closePayment()">
                <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl animate-slide-up">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg flex items-center"><i data-lucide="shield-check" class="text-green-600 mr-2"></i> ì•ˆì „ê²°ì œ</h3>
                        <button onclick="closePayment()" class="text-stone-400 hover:text-stone-600">âœ•</button>
                    </div>
                    <div class="flex gap-4 mb-6 border-b pb-6">
                        <img src="${item.image}" class="w-20 h-20 rounded-lg object-cover bg-stone-200">
                        <div>
                            <h4 class="font-bold text-lg">${item.name}</h4>
                            <p class="text-sm text-stone-500 mb-1">${item.seller}ë‹˜ íŒë§¤</p>
                            <p class="text-green-700 font-bold text-xl">${item.price.toLocaleString()}ì›</p>
                        </div>
                    </div>
                    
                    <!-- í† ìŠ¤ ê²°ì œ UI ìœ„ì ¯ ì˜ì—­ -->
                    <div id="payment-method"></div>
                    <div id="agreement"></div>

                    <button id="payment-button" class="w-full py-3 bg-green-700 text-white rounded-xl font-bold shadow-lg hover:bg-green-800 transition-colors mt-4">
                        ${item.price.toLocaleString()}ì› ê²°ì œí•˜ê¸°
                    </button>
                </div>
            </div>
        `;

        // --- [Logic] ì‹œìŠ¤í…œ ë¡œì§ ---
        window.setActiveTab = (tab) => { state.activeTab = tab; render(); };
        window.goHome = () => { state.viewFilter = 'all'; setActiveTab('market'); };
        window.goTab = (tab) => { if(tab === 'market') state.viewFilter = 'all'; setActiveTab(tab); };
        window.setViewFilter = (filter) => { state.viewFilter = filter; setActiveTab('market'); };

        window.toggleLogin = (show) => { state.modals.login = show; render(); };
        window.login = () => { 
            const nicknameInput = document.getElementById('loginNickname');
            const nickname = nicknameInput && nicknameInput.value ? nicknameInput.value : 'í–‰ë³µí•œë‚˜ë¬´';
            state.isLoggedIn = true; 
            state.currentUser = { id: 'user_' + Date.now(), name: nickname, email: 'user@test.com', isPremium: false }; 
            Toast.show(`í™˜ì˜í•©ë‹ˆë‹¤, ${nickname}ë‹˜!`);
            toggleLogin(false); 
        };
        window.logout = () => { 
            state.isLoggedIn = false; state.currentUser = null; state.viewFilter = 'all'; 
            Toast.show('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            setActiveTab('market'); 
        };

        // ì„¤ì • ê´€ë¦¬
        window.openSettings = () => { if(!state.isLoggedIn) return; state.modals.settings = true; render(); };
        window.closeSettings = () => { state.modals.settings = false; render(); };
        window.saveSettings = () => {
            const newName = document.getElementById('settingsNickname').value;
            if(newName && newName.trim() !== '') {
                state.listings = state.listings.map(l => l.sellerId === state.currentUser.id ? {...l, seller: newName} : l);
                state.currentUser.name = newName;
                Toast.show('ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeSettings();
                render(); 
            }
        };

        // ë©¤ë²„ì‹­ ì—…ê·¸ë ˆì´ë“œ
        window.upgradeMembership = () => {
            if(!confirm('ë‚˜ë¬´ íŒ¨ìŠ¤(Premium)ë¡œ ì—…ê·¸ë ˆì´ë“œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë°ëª¨: ë¬´ë£Œ)')) return;
            state.currentUser.isPremium = true;
            state.listings = state.listings.map(l => l.sellerId === state.currentUser.id ? {...l, isPremium: true} : l);
            Toast.show('ë‚˜ë¬´ íŒ¨ìŠ¤ íšŒì›ì´ ë˜ì‹  ê²ƒì„ ì¶•í•˜í•©ë‹ˆë‹¤!', 'gold');
            render();
        };

        window.handleSearch = (val) => { state.searchTerm = val; render(); const input = document.querySelector('input[type="text"]'); if(input) { input.focus(); input.setSelectionRange(val.length, val.length); } };
        window.setCategory = (cat) => { state.selectedCategory = cat; render(); };

        window.startChat = (itemId) => {
            if (!state.isLoggedIn) return toggleLogin(true);
            const item = state.listings.find(l => l.id === itemId);
            if(item.sellerId === state.currentUser.id) return Toast.show('ë³¸ì¸ ìƒí’ˆê³¼ëŠ” ì±„íŒ…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            let chat = state.chats.find(c => c.itemId === itemId);
            if (!chat) {
                chat = { id: Date.now(), partnerName: item.seller, lastMessage: 'ì±„íŒ…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', time: 'ë°©ê¸ˆ', itemId, unread: 0, messages: [] };
                state.chats.unshift(chat);
            }
            state.activeChatId = chat.id;
            setActiveTab('chat');
        };
        window.setActiveChat = (id) => { state.activeChatId = id; if(id) { const chat = state.chats.find(c => c.id === id); if(chat) chat.unread = 0; } render(); };
        window.sendMessage = (text, inputEl) => {
            if (!text.trim()) return;
            const chat = state.chats.find(c => c.id === state.activeChatId);
            chat.messages.push({ sender: 'me', text, time: 'ë°©ê¸ˆ' });
            chat.lastMessage = text;
            inputEl.value = '';
            render();
            setTimeout(() => {
                const replies = ["ì•ˆë…•í•˜ì„¸ìš”! êµ¬ë§¤ ê°€ëŠ¥í•©ë‹ˆë‹¤. ğŸŒ³", "ì§€ì—­ì´ ì–´ë””ì‹ ê°€ìš”?", "ë„¤! ì—°ë½ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤."];
                const reply = replies[Math.floor(Math.random() * replies.length)];
                chat.messages.push({ sender: 'partner', text: reply, time: 'ë°©ê¸ˆ' });
                chat.lastMessage = reply;
                render();
            }, 1000); 
        };

        window.openPayment = (itemId) => { 
            if (!state.isLoggedIn) return toggleLogin(true); 
            const item = state.listings.find(i => i.id === itemId);
            state.modals.payment = item; 
            render(); 
        };
        window.closePayment = () => { state.modals.payment = null; render(); };

        // === [Toss Payments Integration] ===
        window.renderTossWidget = async (item) => {
            const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
            const customerKey = "xOPRSuQz2au21GSMTnWls"; // ì‹¤ì œë¡œëŠ” ìœ ì € ê³ ìœ  ID ì‚¬ìš©
            
            try {
                const tossPayments = TossPayments(clientKey);
                const widgets = tossPayments.widgets({ customerKey });
                
                await widgets.setAmount({
                    currency: "KRW",
                    value: item.price,
                });

                await Promise.all([
                    widgets.renderPaymentMethods({ selector: "#payment-method", variantKey: "DEFAULT" }),
                    widgets.renderAgreement({ selector: "#agreement", variantKey: "AGREEMENT" }),
                ]);

                const button = document.getElementById("payment-button");
                button.addEventListener("click", async function () {
                    try {
                        await widgets.requestPayment({
                            orderId: "ORDER_" + Date.now(), // ê³ ìœ  ì£¼ë¬¸ ID
                            orderName: item.name,
                            successUrl: window.location.origin + "?success=true", // ë°ëª¨ìš©
                            failUrl: window.location.origin + "?fail=true",
                            customerEmail: state.currentUser.email,
                            customerName: state.currentUser.name,
                        });
                    } catch (error) {
                        console.error(error);
                        Toast.show('ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                });
            } catch (error) {
                console.error("í† ìŠ¤ ìœ„ì ¯ ë¡œë“œ ì‹¤íŒ¨:", error);
                document.getElementById("payment-method").innerHTML = "<p class='text-red-500 text-center'>ê²°ì œ ì‹œìŠ¤í…œì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
            }
        };

        window.updateSellForm = (key, value) => { state.sellForm[key] = value; if(key === 'isBusiness') render(); };
        window.handleImageUpload = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { state.sellForm.previewImage = e.target.result; render(); };
                reader.readAsDataURL(input.files[0]);
            }
        };
        window.handleSellSubmit = (e) => {
            e.preventDefault();
            if (!state.sellForm.previewImage && !confirm("ì‚¬ì§„ ì—†ì´ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const newItem = { 
                id: Date.now(), 
                ...state.sellForm, 
                price: Number(state.sellForm.price), 
                seller: state.currentUser.name,
                sellerId: state.currentUser.id, 
                isPremium: state.currentUser.isPremium,
                image: state.sellForm.previewImage || 'https://images.unsplash.com/photo-1502082553048-f009c37129b9?w=400&q=80', 
                status: 'íŒë§¤ì¤‘' 
            };
            state.listings.unshift(newItem);
            StorageSystem.save(state);
            Toast.show('íŒë§¤ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            state.sellForm = { name: '', category: 'ì¡°ê²½ìˆ˜', price: '', height: '', location: '', description: '', isBusiness: false, businessName: '', businessRegNumber: '', previewImage: null };
            setActiveTab('market');
        };

        window.deleteListing = (itemId) => {
            if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                state.listings = state.listings.filter(item => item.id !== itemId);
                StorageSystem.save(state);
                Toast.show('íŒë§¤ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                render();
            }
        };
        
        window.toggleStatus = (itemId) => {
            const item = state.listings.find(i => i.id === itemId);
            if(item) {
                item.status = item.status === 'íŒë§¤ì¤‘' ? 'íŒë§¤ì™„ë£Œ' : 'íŒë§¤ì¤‘';
                StorageSystem.save(state);
                Toast.show(`ìƒíƒœê°€ '${item.status}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                render();
            }
        };

        window.generateDescription = async () => {
            if(!state.sellForm.name) return Toast.show('ë‚˜ë¬´ ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
            state.isGenerating = true; render();
            await new Promise(r => setTimeout(r, 1500)); 
            state.sellForm.description = `ì´ ${state.sellForm.name}ì€(ëŠ”) ì •ë§ íŠ¼íŠ¼í•˜ê³  ìˆ˜í˜•ì´ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤. ${state.sellForm.location}ì—ì„œ ì •ì„±ê» í‚¤ì› ìŠµë‹ˆë‹¤.`;
            state.isGenerating = false; render();
        };
        window.toggleAIChat = (show) => { state.showAIChat = show; render(); };
        window.sendAIChat = async (text, inputEl) => {
            if(!text.trim()) return;
            state.aiChatMessages.push({ role: 'user', text });
            inputEl.value = ''; render();
            await new Promise(r => setTimeout(r, 1000));
            state.aiChatMessages.push({ role: 'model', text: "ë¬¼ì£¼ê¸°ëŠ” 'ê²‰í™ì´ ë§ëì„ ë•Œ í ë»‘' ì£¼ëŠ” ê²ƒì´ ê¸°ë³¸ì…ë‹ˆë‹¤. ğŸ’§" });
            render();
        };

        render();
    </script>
</body>
</html>